package database

import (
	"context"
	"log"
	"main/middlewares"
	"main/models"
	"net"
	"os"
	"time"

	"github.com/redis/go-redis/v9"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/trace"
)

var ctx = context.Background()
var rdb *redis.Client

func SetupDB() {

	_, span := middlewares.GetOpenTelemetry().Start(
		ctx,
		"SetupDB",
	)
	defer span.End()

	span.SetAttributes(attribute.String("setupdb", "conexion db"))

	redisConfig := getRedisCredentials()

	rdb = redis.NewClient(&redis.Options{
		Addr:         redisConfig.Addr,
		Password:     redisConfig.Password,
		Username:     redisConfig.User,
		DB:           redisConfig.DB,
		ReadTimeout:  3 * time.Second,
		WriteTimeout: 3 * time.Second,
		PoolSize:     10,
		PoolTimeout:  3 * time.Second,
		DialTimeout:  3 * time.Second,
	})

	status, err := rdb.Ping(ctx).Result()

	if err != nil && status != "PONG" {

		dataTrace := &models.DataTrace{
			FunctionName: "Setupdb",
			FileName:     "redis.go",
			Data:         "cannot conection to db",
			Error:        err,
		}

		attributes := middlewares.SetAttributesFailedDB(dataTrace)
		span.AddEvent("log", trace.WithAttributes(attributes...))
		log.Panic("ERROR | Sin resultado pong")

	} else {
		log.Printf("[REDIS CONECTADO]")
	}

}

func getRedisCredentials() models.RedisConfig {

	var redisConfig models.RedisConfig
	var ok bool

	redisConfig.DB = 0
	redisConfig.Host, ok = os.LookupEnv("REDISHOST")

	if !ok {
		redisConfig.Host = "localhost"
	}

	redisConfig.Port, ok = os.LookupEnv("REDISPORT")

	if !ok {
		redisConfig.Port = "6479"
	}

	redisConfig.Addr = net.JoinHostPort(redisConfig.Host, redisConfig.Port)

	redisConfig.Password, ok = os.LookupEnv("REDISPASSWORD")

	if !ok {
		redisConfig.Password = "55nt8SH68VD_r7UCga2iR277%6d6_nEEt_XokN+1NEP7S6f_3fB"
	}

	redisConfig.User, ok = os.LookupEnv("REDISUSER")

	if !ok {
		redisConfig.User = "default"
	}

	return redisConfig

}

func GetStrKey(key string) (string, error) {
	response, err := rdb.Get(ctx, key).Result()
	return response, err
}

func SetStrKey(key string, value string) bool {

	ctx, span := middlewares.GetOpenTelemetry().Start(
		ctx,
		"SetStrKey",
	)
	defer span.End()

	response, err := rdb.Set(ctx, key, value, redis.KeepTTL).Result()
	if err != nil {
		dataTrace := &models.DataTrace{
			FunctionName: "SetStrKey",
			FileName:     "redis.go",
			Data:         "cannot save to DB",
			Error:        err,
		}

		attributes := middlewares.SetAttributesFailedDB(dataTrace)
		span.AddEvent("log", trace.WithAttributes(attributes...))

		// log.Panicf("Error | Cannot save key %s for this content %v", key, value)
	}
	if response != "OK" {
		dataTrace := &models.DataTrace{
			FunctionName: "SetStrKey",
			FileName:     "redis.go",
			Data:         "cannot save to DB",
			Error:        err,
		}

		attributes := middlewares.SetAttributesFailedDB(dataTrace)
		span.AddEvent("log", trace.WithAttributes(attributes...))

		return false
	}

	return true
}

func Incr(key string) (int64, error) {

	status, err := rdb.Incr(ctx, key).Result()
	return status, err

}
